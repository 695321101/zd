# MinimalLightBrowser 软件自诉文件

## 1. 软件基本信息

- **软件名称**: MinimalLightBrowser
- **软件类型**: 轻量级网页浏览器
- **开发语言**: Python
- **开发框架**: PyQt5 + PyQtWebEngine
- **目标平台**: Windows
- **软件版本**: 1.0
- **主要功能**: 极简界面、悬浮输入条、历史消息记录、运行日志终端、截图上传集成

## 2. 软件功能概述

MinimalLightBrowser 是一款专为特定场景设计的轻量级浏览器，其核心价值在于提供极简的用户界面体验，同时集成了丰富的辅助功能。该浏览器采用主窗口与悬浮输入条分离的设计模式，允许用户在保持主浏览器最小化的情况下，通过悬浮界面进行操作和交互。

### 核心功能特性

1. **极简界面设计**
   - 无黑色元素的明亮界面
   - 主窗口默认最小化，减少视觉干扰
   - 专注于内容浏览体验

2. **悬浮输入系统**
   - 独立的悬浮聊天窗口
   - 可拖动、可置顶的界面设计
   - 自适应高度的文本输入框

3. **历史消息管理**
   - 按日期分组的对话历史记录
   - 美观的消息气泡界面
   - 一键清空历史功能

4. **运行日志终端**
   - 实时运行状态监控
   - 详细的操作日志记录
   - 错误和警告提示

5. **智能截图上传**
   - 自动屏幕截图功能
   - 智能检测并填充文件上传控件
   - 多种上传失败应对策略

6. **自动回复监测**
   - 用户消息发送状态跟踪
   - 机器人回复内容实时监测
   - 回复完成智能判断

7. **数据持久化**
   - 浏览器缓存和Cookie本地存储
   - 自定义存储路径设置

## 3. 技术架构

### 系统架构

MinimalLightBrowser 采用模块化设计，各组件之间通过清晰的接口进行交互，实现了高内聚低耦合的架构特性。系统主要由以下核心模块组成：

1. **界面层**
   - 主窗口 (`MinimalLightBrowser`)
   - 悬浮聊天窗口 (`FloatingChatWindow`)
   - 历史消息面板 (`HistoryPanel`)
   - 终端日志面板 (`TerminalPanel`)
   - 消息气泡组件 (`MessageBubble`)
   - 日期分隔符 (`DateSeparator`)

2. **功能层**
   - 浏览器视图模块 (`BrowserView`)
   - 截图上传模块 (`ScreenshotHandler`)
   - 回复监控模块 (`ResponseMonitor`)

3. **数据层**
   - 本地存储管理
   - 会话数据管理

### 核心类图关系

```
MinimalLightBrowser (主窗口)
    ├── BrowserView (浏览器视图)
    ├── FloatingChatWindow (悬浮聊天窗口)
    │   ├── HistoryPanel (历史面板)
    │   └── TerminalPanel (终端面板)
    ├── ScreenshotHandler (截图处理)
    └── ResponseMonitor (回复监控)
        ├── HistoryPanel (历史面板)
        └── FloatingChatWindow (悬浮聊天窗口)
```

### 数据流向

1. 用户输入 → 悬浮窗口 → 浏览器视图执行JavaScript → 页面操作
2. 浏览器状态 → 终端面板显示日志
3. 页面变化 → 回复监控 → 历史面板记录消息
4. 截图操作 → 截图处理 → 页面文件上传控件

## 4. 关键功能实现

### 4.1 浏览器核心功能

浏览器核心功能通过 `BrowserView` 类实现，该类封装了 `QWebEngineView` 的核心功能，并添加了页面加载状态检测、JavaScript执行等增强功能。页面稳定性检测通过JavaScript注入实现，能够判断页面资源是否完全加载完成。

```python
# 浏览器视图核心实现
def check_page_stability(self):
    # 通过JavaScript检测页面稳定性
    js_check = """
    (function() {
        const hasActiveRequests = performance.getEntriesByType('resource').some(
            entry => entry.responseEnd === 0
        );
        const loadingElements = document.querySelectorAll('img[loading], iframe[loading]');
        const hasLoadingElements = Array.from(loadingElements).some(el => el.complete === false);
        return !hasActiveRequests && !hasLoadingElements;
    })();
    """
    # 执行检测并处理结果
    self.web_view.page().runJavaScript(js_check, handle_stability)
```

### 4.2 悬浮输入系统

悬浮输入系统是该浏览器的特色功能，通过 `FloatingChatWindow` 类实现。该窗口采用无边框、半透明设计，支持拖动、置顶等操作，并集成了历史面板和终端面板的切换功能。输入框支持自适应高度，并通过特定键位组合实现消息发送和换行。

### 4.3 截图上传功能

截图上传功能通过 `ScreenshotHandler` 类实现，采用PyQt的屏幕捕获功能获取当前屏幕内容，转换为Base64编码后，通过JavaScript注入到页面中的文件上传控件。该模块采用多种策略查找文件上传控件，并通过触发多种事件确保上传生效。

### 4.4 回复监控系统

回复监控系统通过 `ResponseMonitor` 类实现，能够自动检测用户消息是否成功发送到页面，以及监测机器人的回复状态。该系统使用了多种选择器和检测策略，确保能够适应不同网站的DOM结构变化。回复完成的判断基于内容稳定性检测，当内容连续多次检测保持不变时，判定为回复完成。

## 5. 依赖项与技术栈

| 依赖名称 | 版本要求 | 用途 | 安装命令 |
|---------|---------|------|--------|
| Python | >= 3.6 | 运行环境 | 系统安装 |
| PyQt5 | >= 5.15.0 | GUI框架 | `pip install PyQt5` |
| PyQtWebEngine | >= 5.15.0 | 网页渲染引擎 | `pip install PyQtWebEngine` |

## 6. 使用说明

### 6.1 基本操作

1. **启动软件**：运行 `main.py` 文件启动浏览器
2. **主窗口控制**：点击悬浮窗口的「🏠 主窗口」按钮切换主窗口显示状态
3. **发送消息**：在悬浮输入框中输入文字，按Enter发送消息（Shift+Enter换行）
4. **查看历史**：点击「📜 历史」按钮展开历史消息面板
5. **查看日志**：点击「📊 终端」按钮展开运行日志面板
6. **置顶窗口**：点击「📌 置顶」按钮可将悬浮窗口置顶显示

### 6.2 高级功能

1. **截图上传**：发送消息时会自动进行屏幕截图并尝试上传到页面的文件上传控件
2. **自动监测**：系统会自动监测消息发送状态和回复状态，并在终端面板显示详细日志
3. **历史记录**：历史消息按日期分组显示，支持一键清空功能

## 7. 配置与存储

### 7.1 数据存储

浏览器数据存储在程序目录下的 `browser_data` 文件夹中，包括：

- Cookie 数据
- 本地存储数据
- IndexedDB 数据
- HTTP 缓存

### 7.2 存储路径配置

默认存储路径可在 `setup_storage` 方法中修改：

```python
def setup_storage(self):
    self.storage_path = os.path.join(os.getcwd(), "browser_data")
    os.makedirs(self.storage_path, exist_ok=True)
    # ... 其他存储配置
```

## 8. 开发背景与目标

### 8.1 开发动机

MinimalLightBrowser 的开发动机源于对特定场景下浏览器使用体验的优化需求。传统浏览器界面复杂，容易分散用户注意力，而该项目旨在提供一个更加专注、简洁的浏览环境，同时集成常用的辅助功能，提高特定场景下的使用效率。

### 8.2 项目目标

1. 提供极简、无干扰的浏览界面
2. 实现高效的悬浮输入交互方式
3. 集成有用的辅助功能（历史记录、日志监控、截图上传）
4. 保证稳定可靠的运行体验
5. 适应特定网站（如豆包聊天）的交互特性

## 9. 总结与亮点回顾

MinimalLightBrowser 是一款专为特定场景设计的轻量级浏览器，其核心亮点包括：

1. **创新的界面设计**：主窗口与悬浮输入条分离的设计，提供了全新的浏览器使用体验
2. **智能的辅助功能**：自动截图上传、回复监测等功能大大提高了特定场景下的使用效率
3. **稳定的技术实现**：基于PyQt5框架构建，具有良好的跨平台潜力和性能表现
4. **灵活的扩展性**：模块化设计使得功能扩展和定制变得简单

该软件虽然轻量，但功能丰富，特别是在特定聊天场景下，能够提供比传统浏览器更加便捷、高效的使用体验。